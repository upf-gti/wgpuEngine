<script type="text/javascript">

MAKE_HEADER( "wgpuEngine", "h1", "wgpuEngine" );

MAKE_PARAGRAPH( `<strong>wgpuEngine</strong> is an open-source cross-platform engine designed for creating desktop, XR (extended reality), and 3D web applications. Built on top of the newest graphics API  WebGPU, it provides a solution to render complex scenes, animations, and immersive experiences. 
It supports XR via OpenXR for desktop and WebXR for web environments.`);
MAKE_LINE_BREAK();
INSERT_IMAGES( [ "https://github.com/user-attachments/assets/5a190d79-402e-4f69-a7b6-fb505e1488cb", "https://github.com/user-attachments/assets/7b472234-a941-4095-b082-bc5099b0ac1a" ] );
MAKE_LINE_BREAK();
MAKE_LINE_BREAK();
MAKE_PARAGRAPH( `It uses Dawn, which provides WebGPU for desktop and web (via emscripten). We are still using a forked version until the official one adds XR support. 
See ${ INLINE_LINK("Rooms", " https://github.com/upf-gti/rooms") } for an example of how to use this engine.` );

MAKE_LINE_BREAK();

MAKE_HEADER( "Build", "h1", "build" );

MAKE_PARAGRAPH( `You will need to install the following tools:` );

MAKE_BULLET_LIST( [
    INLINE_LINK("Git", "https://git-scm.com/"),
    INLINE_LINK("CMake", "https://cmake.org/download/"),
    INLINE_LINK("Python", "https://www.python.org/") + " (added to your PATH)"
] );

MAKE_PARAGRAPH( `Next step is to add the ${ INLINE_LINK("engine", "https://github.com/upf-gti/wgpuEngine") } as a submodule of your project and initialize the submodules:` );

MAKE_CODE( `git submodule update --init --recursive
` );

MAKE_HEADER( "Desktop", "h2", "desktop" );

MAKE_PARAGRAPH( `Create the build folder and run the ${ INLINE_CODE("CMakeLists.txt") } file using CMake:` );

MAKE_CODE( `mkdir build
cd build
cmake ..
` );

MAKE_HEADER( "Web", "h2", "web" );

MAKE_PARAGRAPH( `Download ${ INLINE_LINK("emscripten", "https://emscripten.org/") } and follow the installation guide.` );

MAKE_PARAGRAPH( `On Windows you may need to download ${ INLINE_LINK("ninja", "https://ninja-build.org/") } and include the folder in your PATH environment variable, then:` );

MAKE_CODE( `mkdir build-web
cd build-web
emcmake cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build .
` );

MAKE_HEADER( "CMakeLists.txt", "h2", "cmakefile" );

MAKE_PARAGRAPH( `You can use the following CMake for your project, used in the ${ INLINE_LINK("wgpuEngine Sample Project", "https://github.com/upf-gti/wgpuEngineSample") }.` );
MAKE_LINE_BREAK();

{
    const content = document.getElementById('content');
    const area = new LX.Area( { className: "", skipAppend: true, height: "32rem" } );
    content.appendChild( area.root );

    const editor = new LX.CodeEditor( area, {
        skipTabs: true,
        skipInfo: true
    } );

    editor.root.querySelector("button.grid.absolute.z-100.p-3").remove();

    editor.setText(`cmake_minimum_required(VERSION 3.13)

set(SAMPLE_PROJECT_DIR_ROOT        \${CMAKE_CURRENT_SOURCE_DIR})
set(SAMPLE_PROJECT_DIR_SOURCES     "\${SAMPLE_PROJECT_DIR_ROOT}/src")
set(SAMPLE_PROJECT_DIR_LIBS        "\${SAMPLE_PROJECT_DIR_ROOT}/libraries")

if (EMSCRIPTEN)
    project(index LANGUAGES C CXX)
else()
    project(sample_project LANGUAGES C CXX)
endif()

# Enable multicore and simd compile on VS solution
if(MSVC)
    add_definitions(/MP)
    add_definitions(/arch:AVX2)

    # enable link time optimization
    if (CMAKE_BUILD_TYPE STREQUAL "Release")
        add_definitions(/GL)
        add_definitions(/LTCG)
    endif()

    # disable exceptions
	string(REGEX REPLACE "/EHsc" "/EHs-c-" CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS}")
endif()

add_definitions(-D_SILENCE_STDEXT_ARR_ITERS_DEPRECATION_WARNING)

# Macro to map filters to folder structure for MSVC projects
macro(GroupSources curdir)
    if(MSVC)
		file(GLOB children RELATIVE \${PROJECT_SOURCE_DIR}/\${curdir} \${PROJECT_SOURCE_DIR}/\${curdir}/*)

        foreach(child \${children})
            if(IS_DIRECTORY \${PROJECT_SOURCE_DIR}/\${curdir}/\${child})
                GroupSources(\${curdir}/\${child})
            else()
                string(REPLACE "/" "\\" groupname \${curdir})
                source_group(\${groupname} FILES \${PROJECT_SOURCE_DIR}/\${curdir}/\${child})
            endif()
        endforeach()
    endif()
endmacro()

GroupSources(src)

# Sources
macro(SAMPLE_PROJECT_FILES_APPEND)
    file(GLOB FILES_APPEND CONFIGURE_DEPENDS \${ARGV})
    list(APPEND SAMPLE_PROJECT_SOURCES \${FILES_APPEND})
endmacro()
macro(SAMPLE_PROJECT_SOURCES_APPEND)
    SAMPLE_PROJECT_FILES_APPEND(\${ARGV0}/*.h)
    SAMPLE_PROJECT_FILES_APPEND(\${ARGV0}/*.cpp)
endmacro()

SAMPLE_PROJECT_SOURCES_APPEND(\${SAMPLE_PROJECT_DIR_SOURCES})
SAMPLE_PROJECT_SOURCES_APPEND(\${SAMPLE_PROJECT_DIR_SOURCES}/engine)
SAMPLE_PROJECT_SOURCES_APPEND(\${SAMPLE_PROJECT_DIR_SOURCES}/graphics)

add_executable(\${PROJECT_NAME} \${SAMPLE_PROJECT_SOURCES})

target_include_directories(\${PROJECT_NAME} PUBLIC \${SAMPLE_PROJECT_DIR_SOURCES})

set_property(TARGET \${PROJECT_NAME} PROPERTY CXX_STANDARD 20)

# OS Dependant project setup
if(APPLE)
    set_target_properties(\${PROJECT_NAME} PROPERTIES 
            XCODE_GENERATE_SCHEME TRUE 
            XCODE_SCHEME_WORKING_DIRECTORY \${SAMPLE_PROJECT_DIR_ROOT})
    set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -g")
elseif(MSVC)
    set_property(TARGET \${PROJECT_NAME} PROPERTY VS_DEBUGGER_WORKING_DIRECTORY "\${SAMPLE_PROJECT_DIR_ROOT}")
    set_property(DIRECTORY \${SAMPLE_PROJECT_DIR_ROOT} PROPERTY VS_STARTUP_PROJECT \${PROJECT_NAME})
endif()

if (MSVC)
    add_compile_options(/Zc:__cplusplus)
endif()

if (EMSCRIPTEN)
    set(SHELL_FILE shell.html)

    include_directories(BEFORE
        "\${CMAKE_BINARY_DIR}/_deps/emdawn-src/include/"
    )

    add_library(webgpu_layer
        "\${CMAKE_BINARY_DIR}/_deps/emdawn-src/webgpu.cpp"
    )
    target_link_libraries(\${PROJECT_NAME}
        webgpu_layer
    )

    add_compile_options(
        "$<$<CONFIG:Release>:-flto>"
    )

    add_link_options(
        "$<$<CONFIG:Release>:-flto>"
    )

    # See https://github.com/kainino0x/webgpu-cross-platform-demo/tree/dawnwasm for a sample setup

    # Add Embind bindings to JS from the engine's binding file
    target_sources(\${PROJECT_NAME} PRIVATE \${SAMPLE_PROJECT_DIR_LIBS}/wgpuEngine/embind_bindings.cpp)

    target_link_options(\${PROJECT_NAME} PRIVATE

        # We are using Dawn-generated bindings, not built-in ones
        -sUSE_WEBGPU=0
        # The JS libraries needed for bindings
        "--js-library=\${CMAKE_BINARY_DIR}/_deps/emdawn-src/library_webgpu_enum_tables.js"
        "--js-library=\${CMAKE_BINARY_DIR}/_deps/emdawn-src/library_webgpu_generated_struct_info.js"
        "--js-library=\${CMAKE_BINARY_DIR}/_deps/emdawn-src/library_webgpu_generated_sig_info.js"
        "--js-library=\${CMAKE_BINARY_DIR}/_deps/emdawn-src/library_webgpu.js"
        "--closure-args=--externs=\${CMAKE_BINARY_DIR}/_deps/emdawn-src/webgpu-externs.js"

        -sEXPORTED_FUNCTIONS=_main,_malloc,_free
        -sUSE_GLFW=3
        -sALLOW_MEMORY_GROWTH
        -sASYNCIFY
        -Wdeprecated-literal-operator
        -sSTACK_SIZE=5MB
        -sASYNCIFY_STACK_SIZE=10000
        -lembind # to bind functions from c++ to javascript
        -sWASM_BIGINT
        -O1
        # ------------
        --shell-file "\${SAMPLE_PROJECT_DIR_ROOT}/\${SHELL_FILE}"
        --preload-file "\${SAMPLE_PROJECT_DIR_ROOT}/data@/data"
	)

	# Make sure to re-link when the shell file changes
    set_property(
        TARGET \${PROJECT_NAME}
        PROPERTY LINK_DEPENDS
        "\${SAMPLE_PROJECT_DIR_ROOT}/\${SHELL_FILE}"
    )

    set_target_properties(\${PROJECT_NAME} PROPERTIES SUFFIX ".html")
endif()

# wgpuEngine
add_subdirectory(libraries/wgpuEngine)
target_link_libraries(\${PROJECT_NAME} webgpuEngine)

# Enable multicore compile on VS solution
if(MSVC)
  add_definitions(/MP)
endif()`, "CMake" );

MAKE_LINE_BREAK();

}

</script>